# メモ

ChatGPT3時代に出力して貰ったコード。  
テーブルが存在しない時だけテーブルを作成する処理を実行するだけなら、こんなSQL文を書かなくて良いが、OracleのPL/SQLにはこのような書き方もある、という事を残しておく為のメモ。  

``` cs
// テーブルの作成
// 1. BEGIN:
//  PL/SQLブロックの開始を示します。
// 2. EXECUTE IMMEDIATE:
//  動的SQL文を実行するためのコマンドです。
//  この場合、CREATE TABLE 文を実行して SampleTable テーブルを作成します。
// 3. CREATE TABLE SampleTable:
//  SampleTable という名前のテーブルを作成します。
//  Id 列は NUMBER 型で、自動的に生成されるIDです。
//  Name 列は最大100文字の VARCHAR2 型です。
//  Age 列は NUMBER 型です。
// 4. EXCEPTION:
//  例外処理ブロックの開始を示します。
// 5. WHEN OTHERS THEN:
//  すべての例外をキャッチします。
// 6. IF SQLCODE != -955 THEN:
//  SQLCODE が -955 でない場合にのみ例外を再度発生させます。
//  -955 は「テーブルがすでに存在する」というエラーコードです。
// 7. RAISE:
//  例外を再度発生させます。
// 8. END:
//  PL/SQLブロックの終了を示します。        
var createTableQuery = """
    BEGIN
        EXECUTE IMMEDIATE 'CREATE TABLE SampleTable (
            Id NUMBER GENERATED BY DEFAULT AS IDENTITY,
            Name VARCHAR2(100),
            Age NUMBER
        )';
    EXCEPTION
        WHEN OTHERS THEN
            IF SQLCODE != -955 THEN
                RAISE;
            END IF;
    END;
    """;
db.Execute(createTableQuery);
```

## トップレベルステートメントを使用しない場合の記述

``` cs
using Dapper;
using Oracle.ManagedDataAccess.Client;

namespace DockerOracle;

internal class Program
{
    static void Main(string[] args)
    {

        string connectionString = "User Id=sys;Password=passw0rd;DBA Privilege=SYSDBA;Data Source=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1521)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=XE)));";
        
        // DB接続
        using OracleConnection db = new(connectionString);

        // テーブルの作成または初期化
        CreateOrTruncateTable(db);

        // データの挿入
        InsertData(db, "John Doe", 30);
        InsertData(db, "Hoge Fuga", 25);
        InsertData(db, "Piyo Piyo", 20);

        // データの選択と表示
        Console.WriteLine("Initial Data:");
        DisplayData(db);

        // データの更新
        Console.WriteLine("Update Data:");
        UpdateData(db, "UPDATEEEEEEEEEEEEEEE", 35);

        // データの再選択と表示
        DisplayData(db);

        // データの削除
        Console.WriteLine("Delete Data:");
        DeleteData(db);

        // データの再選択と表示
        DisplayData(db);
    }

    
    /// <summary>
    /// テーブルの作成または初期化
    /// </summary>
    /// <param name="db"></param>
    static void CreateOrTruncateTable(OracleConnection db)
    {
        var createTableQuery = """
            DECLARE
                table_count INTEGER;
            BEGIN
                SELECT COUNT(*) INTO table_count FROM user_tables WHERE table_name = 'SAMPLETABLE';
                IF table_count = 0 THEN
                    EXECUTE IMMEDIATE 'CREATE TABLE SampleTable (
                        Id NUMBER GENERATED BY DEFAULT AS IDENTITY,
                        Name VARCHAR2(100),
                        Age NUMBER
                    )';
                ELSE
                    EXECUTE IMMEDIATE 'TRUNCATE TABLE SampleTable';
                END IF;
            END;
            """;
        db.Execute(createTableQuery);
    }

    /// <summary>
    /// データの挿入
    /// </summary>
    /// <param name="db"></param>
    /// <param name="name"></param>
    /// <param name="age"></param>
    static void InsertData(OracleConnection db, string name, int age)
    {
        var insertQuery = "INSERT INTO SampleTable (Name, Age) VALUES (:Name, :Age)";
        db.Execute(insertQuery, new { Name = name, Age = age });
    }

    /// <summary>
    /// データの表示
    /// </summary>
    /// <param name="db"></param>
    static void DisplayData(OracleConnection db)
    {
        var selectQuery = "SELECT * FROM SampleTable";
        var data = db.Query<SampleTable>(selectQuery);
        foreach (var item in data)
        {
            Console.WriteLine($"ID: {item.Id}, Name: {item.Name}, Age: {item.Age}");
        }
    }

    /// <summary>
    /// データの更新
    /// </summary>
    /// <param name="db"></param>
    /// <param name="name"></param>
    /// <param name="age"></param>
    static void UpdateData(OracleConnection db, string name, int age)
    {
        var selectQuery = "SELECT * FROM SampleTable";
        var data = db.Query<SampleTable>(selectQuery);
        var updateID = data.First().Id;
        var updateQuery = "UPDATE SampleTable SET Name = :Name, Age = :Age WHERE ID = :id";
        db.Execute(updateQuery, new { ID = updateID, Name = name, Age = age });
    }

    /// <summary>
    /// データの削除
    /// </summary>
    /// <param name="db"></param>
    static void DeleteData(OracleConnection db)
    {
        var selectQuery = "SELECT * FROM SampleTable";
        var data = db.Query<SampleTable>(selectQuery);
        var deleteID = data.Last().Id;
        var deleteQuery = "DELETE FROM SampleTable WHERE ID = :id";
        db.Execute(deleteQuery, new { ID = deleteID });
    }
}

public class SampleTable
{
    public int Id { get; set; }
    public string? Name { get; set; }
    public int Age { get; set; }
}
```
